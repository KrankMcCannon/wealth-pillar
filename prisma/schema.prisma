generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model accounts {
  id                     String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                   String
  type                   String
  user_ids               String[]                 @default([]) @db.Uuid
  group_id               String                   @db.Uuid
  created_at             DateTime?                @default(now()) @db.Timestamptz(6)
  updated_at             DateTime?                @default(now()) @db.Timestamptz(6)
  recurring_transactions recurring_transactions[]
  users                  users[]

  @@index([group_id], map: "idx_accounts_group_id")
  @@index([type], map: "idx_accounts_type")
  @@index([user_ids], map: "idx_accounts_user_ids", type: Gin)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model budgets {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  description String
  amount      Decimal   @db.Decimal(10, 2)
  type        String    @default("monthly")
  icon        String?
  categories  Json      @default("[]")
  user_id     String    @db.Uuid
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  updated_at  DateTime? @default(now()) @db.Timestamptz(6)
  group_id    String?   @db.Uuid

  @@index([amount], map: "idx_budgets_amount")
  @@index([categories], map: "idx_budgets_categories", type: Gin)
  @@index([type], map: "idx_budgets_type")
  @@index([user_id], map: "idx_budgets_user_id")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model categories {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  key        String    @unique
  label      String
  icon       String
  color      String
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  updated_at DateTime? @default(now()) @db.Timestamptz(6)
  group_id   String    @db.Uuid
  groups     groups    @relation(fields: [group_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([group_id], map: "idx_categories_group_id")
  @@index([key], map: "idx_categories_key")
  @@index([label], map: "idx_categories_label")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model group_invitations {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  group_id           String    @db.Uuid
  invited_by_user_id String    @db.Uuid
  email              String    @db.VarChar(255)
  status             String    @default("pending") @db.VarChar(20)
  invitation_token   String    @unique @db.VarChar(255)
  expires_at         DateTime  @db.Timestamptz(6)
  accepted_at        DateTime? @db.Timestamptz(6)
  created_at         DateTime  @default(now()) @db.Timestamptz(6)
  updated_at         DateTime  @default(now()) @db.Timestamptz(6)
  groups             groups    @relation(fields: [group_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  users              users     @relation(fields: [invited_by_user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([email], map: "idx_group_invitations_email")
  @@index([email, group_id, status], map: "idx_group_invitations_email_group_status")
  @@index([group_id], map: "idx_group_invitations_group_id")
  @@index([status], map: "idx_group_invitations_status")
  @@index([invitation_token], map: "idx_group_invitations_token")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model groups {
  id                      String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                    String
  description             String?
  user_ids                String[]            @default([]) @db.Uuid
  plan                    Json                @default("{\"name\": \"Piano Gratuito\", \"type\": \"free\"}")
  is_active               Boolean             @default(true)
  created_at              DateTime?           @default(now()) @db.Timestamptz(6)
  updated_at              DateTime?           @default(now()) @db.Timestamptz(6)
  subscription_status     String?             @default("free") @db.VarChar(20)
  subscription_expires_at DateTime?           @db.Timestamptz(6)
  stripe_customer_id      String?             @db.VarChar(255)
  stripe_subscription_id  String?             @db.VarChar(255)
  categories              categories[]
  group_invitations       group_invitations[]
  transactions            transactions[]

  @@index([is_active], map: "idx_groups_is_active")
  @@index([plan], map: "idx_groups_plan", type: Gin)
  @@index([subscription_status], map: "idx_groups_subscription_status")
  @@index([user_ids], map: "idx_groups_user_ids", type: Gin)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model recurring_transactions {
  id               String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  description      String
  amount           Decimal        @db.Decimal(12, 2)
  type             String         @db.VarChar(50)
  account_id       String         @db.Uuid
  start_date       DateTime       @db.Date
  end_date         DateTime?      @db.Date
  frequency        String         @db.VarChar(20)
  is_active        Boolean        @default(true)
  total_executions Int            @default(0)
  created_at       DateTime?      @default(now()) @db.Timestamptz(6)
  updated_at       DateTime?      @default(now()) @db.Timestamptz(6)
  category         String
  transaction_ids  String[]       @default([]) @db.Uuid
  due_day          Int            @default(1)
  user_ids         String[]
  accounts         accounts       @relation(fields: [account_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  transactions     transactions[]

  @@index([account_id], map: "idx_recurring_transactions_account_id")
  @@index([frequency], map: "idx_recurring_transactions_frequency")
  @@index([is_active], map: "idx_recurring_transactions_is_active")
  @@index([user_ids], map: "idx_recurring_transactions_user_ids", type: Gin)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model transactions {
  id                     String                  @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  description            String
  amount                 Decimal                 @db.Decimal(15, 2)
  type                   String                  @db.VarChar(10)
  category               String                  @db.VarChar(255)
  date                   DateTime                @db.Date
  account_id             String                  @db.Uuid
  to_account_id          String?                 @db.Uuid
  created_at             DateTime?               @default(now()) @db.Timestamptz(6)
  updated_at             DateTime?               @default(now()) @db.Timestamptz(6)
  user_id                String?                 @db.Uuid
  group_id               String?                 @db.Uuid
  recurring_series_id    String?                 @db.Uuid
  frequency              String?                 @db.VarChar(20)
  groups                 groups?                 @relation(fields: [group_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_transactions_group_id")
  recurring_transactions recurring_transactions? @relation(fields: [recurring_series_id], references: [id], onUpdate: NoAction, map: "fk_transactions_recurring_series_id")
  users                  users?                  @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_transactions_user_id")

  @@index([account_id, date(sort: Desc)], map: "idx_transactions_account_date")
  @@index([account_id], map: "idx_transactions_account_id")
  @@index([amount], map: "idx_transactions_amount")
  @@index([category], map: "idx_transactions_category")
  @@index([date], map: "idx_transactions_date")
  @@index([group_id], map: "idx_transactions_group_id")
  @@index([recurring_series_id], map: "idx_transactions_recurring_series_id")
  @@index([to_account_id], map: "idx_transactions_to_account_id")
  @@index([type], map: "idx_transactions_type")
  @@index([user_id, category], map: "idx_transactions_user_category")
  @@index([user_id, date(sort: Desc)], map: "idx_transactions_user_date")
  @@index([user_id], map: "idx_transactions_user_id")
  @@index([user_id, type], map: "idx_transactions_user_type")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model user_preferences {
  id                          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id                     String   @unique @db.Uuid
  currency                    String   @default("EUR") @db.VarChar(3)
  language                    String   @default("it-IT") @db.VarChar(5)
  timezone                    String   @default("Europe/Rome") @db.VarChar(50)
  notifications_push          Boolean  @default(true)
  notifications_email         Boolean  @default(false)
  notifications_budget_alerts Boolean  @default(true)
  created_at                  DateTime @default(now()) @db.Timestamptz(6)
  updated_at                  DateTime @default(now()) @db.Timestamptz(6)
  users                       users    @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id], map: "idx_user_preferences_user_id")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model users {
  id                 String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clerk_id           String?             @unique
  name               String
  email              String              @unique
  avatar             String?             @default("")
  theme_color        String?             @default("#3B82F6")
  budget_start_date  Int?                @default(1)
  group_id           String?             @db.Uuid
  role               String?             @default("member")
  budget_periods     Json?               @default("[]")
  created_at         DateTime?           @default(now()) @db.Timestamptz(6)
  updated_at         DateTime?           @default(now()) @db.Timestamptz(6)
  default_account_id String?             @db.Uuid
  group_invitations  group_invitations[]
  transactions       transactions[]
  user_preferences   user_preferences?
  accounts           accounts?           @relation(fields: [default_account_id], references: [id], onUpdate: NoAction)

  @@index([clerk_id], map: "idx_users_clerk_id")
  @@index([email], map: "idx_users_email")
  @@index([group_id], map: "idx_users_group_id")
  @@index([role], map: "idx_users_role")
}
